trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: GitVersion@5 # alternative https://github.com/adamralph/minver
  displayName: Apply git version

- task: DockerCompose@0 # https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/docker-compose?view=azure-devops
  displayName: Docker build images
  inputs:
    action: 'Build services'
    containerregistrytype: 'Azure Container Registry'
    azureSubscription: 'Naos 22463ad3-c6d2-4e7e-911d-c50474250fa0'
    azureContainerRegistry: '{"loginServer":"naossample.azurecr.io", "id" : "/subscriptions/22463ad3-c6d2-4e7e-911d-c50474250fa0/resourceGroups/naos/providers/Microsoft.ContainerRegistry/registries/naossample"}'
    dockerComposeFile: '$(System.DefaultWorkingDirectory)/docker-compose.yml'
    additionalDockerComposeFiles: '$(System.DefaultWorkingDirectory)/docker-compose.override.yml'
    includeLatestTag: true
    additionalImageTags: $(GitVersion.InformationalVersion)

- task: DockerCompose@0 # https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/docker-compose?view=azure-devops
  displayName: Docker push images
  inputs:
    action: 'Push services'
    containerregistrytype: 'Azure Container Registry'
    azureSubscription: 'Naos 22463ad3-c6d2-4e7e-911d-c50474250fa0'
    azureContainerRegistry: '{"loginServer":"naossample.azurecr.io", "id" : "/subscriptions/22463ad3-c6d2-4e7e-911d-c50474250fa0/resourceGroups/naos/providers/Microsoft.ContainerRegistry/registries/naossample"}'
    dockerComposeFile: '$(System.DefaultWorkingDirectory)/docker-compose.yml'
    additionalDockerComposeFiles: '$(System.DefaultWorkingDirectory)/docker-compose.override.yml'
    includeLatestTag: true
    additionalImageTags: $(GitVersion.InformationalVersion)